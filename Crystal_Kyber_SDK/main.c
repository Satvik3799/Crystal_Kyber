#include <stdlib.h>
#include <stdint.h>
#include "ajit_access_routines.h"
#include <cortos.h>
#include <math.h>
#define ACCELERATOR_REGISTERS_BASE_ADDRESS 0xFFFF4000

#include <stdio.h>
#include <stdbool.h>
#include <time.h>

//For memcpy function
// #include <string.h>

//To print 64 bit values
// #include <inttypes.h>

// Define necessary constants
#define q 3329
#define n2 256
#define n 128
#define inv_n 3303
#define psin 17
#define inv_psin 1175
#define k 2


/*


--command word values and address registers for accelerator--



//////////////////////////////////// monte carlo ////////////////////////

-- ------------------------Address Info-------------------
-- 0x00 : Control signals
--        bit 0  - ap_start (Read/Write/COH)
--        bit 1  - ap_done (Read/COR)
--        bit 2  - ap_idle (Read)
--        bit 3  - ap_ready (Read)
--        bit 7  - auto_restart (Read/Write)
--        others - reserved
-- 0x04 : Global Interrupt Enable Register
--        bit 0  - Global Interrupt Enable (Read/Write)
--        others - reserved
-- 0x08 : IP Interrupt Enable Register (Read/Write)
--        bit 0  - Channel 0 (ap_done)
--        bit 1  - Channel 1 (ap_ready)
--        others - reserved
-- 0x0c : IP Interrupt Status Register (Read/TOW)
--        bit 0  - Channel 0 (ap_done)
--        bit 1  - Channel 1 (ap_ready)
--        others - reserved
-- 0x10 : Data signal of lower_bound
--        bit 31~0 - lower_bound[31:0] (Read/Write)
-- 0x14 : Data signal of lower_bound
--        bit 31~0 - lower_bound[63:32] (Read/Write)
-- 0x18 : reserved
-- 0x1c : Data signal of upper_bound
--        bit 31~0 - upper_bound[31:0] (Read/Write)
-- 0x20 : Data signal of upper_bound
--        bit 31~0 - upper_bound[63:32] (Read/Write)
-- 0x24 : reserved
-- 0x28 : Data signal of num_samples
--        bit 31~0 - num_samples[31:0] (Read/Write)
-- 0x2c : Data signal of num_samples
--        bit 31~0 - num_samples[63:32] (Read/Write)
-- 0x30 : reserved
-- 0x34 : Data signal of final_integral
--        bit 31~0 - final_integral[31:0] (Read)
-- 0x38 : Data signal of final_integral
--        bit 31~0 - final_integral[63:32] (Read)
-- 0x3c : Control signal of final_integral
--        bit 0  - final_integral_ap_vld (Read/COR)
--        others - reserved
-- (SC = Self Clear, COR = Clear on Read, TOW = Toggle on Write, COH = Clear on Handshake)



*/


// Function prototypes
void gen_tf(uint16_t *psis, uint16_t *inv_psis);
void gen_pwmf(uint16_t *pwmf);
void ntt_256(uint16_t *x, uint16_t *psis);
void intt_256(uint16_t *y, uint16_t *inv_psis);
void point_wise_mult(uint16_t *y3, uint16_t *y1, uint16_t *y2, uint16_t *pwmf);
void addr_gen(uint16_t s, uint16_t i, uint16_t l, uint16_t v, uint16_t *ie_r, uint16_t *io_r, uint16_t *iw);
void ct_ntt(uint16_t *a, uint16_t *psis);
void gs_intt(uint16_t *a, uint16_t *inv_psis);
void butterfly_dit(uint16_t w, uint16_t u, uint16_t v, uint16_t *x, uint16_t *y);
void butterfly_dif(uint16_t w, uint16_t u, uint16_t v, uint16_t *x, uint16_t *y);
uint16_t barret_reduction(uint16_t c1);

void setup()
{
	// configure uart
	__ajit_serial_configure__(1,0,0);
	__ajit_serial_set_baudrate__ (115200, 50000000);
	__ajit_serial_set_uart_reset__ (0);

	cortos_printf ("enabled serial.\n");

	// enable interrupt controller for the current thread.

	enableInterruptControllerAndAllInterrupts(0,0);
	cortos_printf ("enabled interrupt controller.\n");

}


void write_to_accelerator_register (uint16_t reg_id, uint16_t val)
{
	__ajit_store_word_mmu_bypass__(val, ACCELERATOR_REGISTERS_BASE_ADDRESS + (reg_id));
}


uint16_t read_from_accelerator_register (uint16_t reg_id)
{
	uint16_t val = __ajit_load_word_mmu_bypass__ (ACCELERATOR_REGISTERS_BASE_ADDRESS + (reg_id));
	return(val);
}

void my_external_interrupt_handler ()
{

}

// Implementations of the functions

//QC - Passed
uint16_t bit_reverse(uint16_t num, uint16_t logn) {
    
    uint16_t rev_num = 0;
    uint16_t i;
    // cortos_printf("logn = %d\n", logn);
    // cortos_printf("num = %d\n", num);
    for ( i = 0; i < logn; i++) {
        if ((num >> i) & 1) {
            rev_num |= 1 << (logn - 1 - i);
            // cortos_printf("rev_num = %d\n", rev_num);
        }
    }
    
    // cortos_printf("rev_num = %d\n", rev_num);
    return rev_num;

}

//QC - Passed
void gen_tf( uint16_t *psis, uint16_t *inv_psis) {
    uint16_t logn = (uint16_t)log2(n);
    // cortos_printf("logn = %d", logn);
    uint16_t positions[n];
    uint16_t x;
    // cortos_printf ("positions start\n");
    for ( x = 0; x < n; x++) {
        positions[x] = bit_reverse(x, logn);
    }
    // cortos_printf ("psi, inv_psi start\n");
    uint16_t psi = 1, inv_psi = 1;
    for ( x = 0; x < n; x++) {
        psis[positions[x]] = psi;
        inv_psis[positions[x]] = inv_psi;

        // cortos_printf("loop counter - %d\n", x);
        // cortos_printf("psis[%u] - %llu\n", positions[x], (unsigned long long) psis[positions[x]]);
        // cortos_printf("inv_psis[%u] - %llu\n", positions[x], (unsigned long long) inv_psis[positions[x]]);
        
        psi = (uint32_t)psi * psin % q;
        inv_psi = (uint32_t)inv_psi * inv_psin % q;
    }

    // // Print the PSIS array
    // cortos_printf("Inside function, PSIS array:\n");
    // for ( x = 0; x < n; x++) {
    //     cortos_printf("%u \n ", psis[x]);
    // }
    // cortos_printf("\n");

    // // Print the INV_PSIS array
    // cortos_printf("Inside function, INV_PSIS array:\n");
    // for ( x = 0; x < n; x++) {
    //     cortos_printf("%u ", inv_psis[x]);
    //     // cortos_printf("loop counter - %d\n", x);
    // }
    // cortos_printf("\n");
}

//QC - Passed
void gen_pwmf(uint16_t *pwmf) {
    uint16_t logn = (uint16_t)log2(n);
    uint16_t i;
    for ( i = 0; i < n; i++) {
        uint16_t exponent = 2 * bit_reverse(i, logn) + 1;
        uint32_t val = 1;
        uint16_t base = psin;

        // Compute psin^exponent % q using an iterative approach
        while (exponent > 0) {
            if (exponent % 2 == 1) {
                val = (val * base) % q;
            }
            base = (base * base) % q;
            exponent /= 2;
        }

        pwmf[i] = val;
    }
    
    // Print the PWMF array
    // cortos_printf(" Inside Function, PWMF array:\n");
    // for (uint16_t i = 0; i < n; i++) {
    //     cortos_printf("%u ", pwmf[i]);
    // }
    // cortos_printf("\n");
}


void ntt_256(uint16_t *x, uint16_t *psis) {
    // cortos_printf("NTT start!");
    uint16_t xe[128], xo[128];
    uint16_t i;
    for ( i = 0; i < 128; i++) {
        xe[i] = x[2 * i];
        xo[i] = x[2 * i + 1];
    }
    ct_ntt(xe, psis);
    ct_ntt(xo, psis);
    for ( i = 0; i < 128; i++) {
        x[i] = xe[i];
        x[i + 128] = xo[i];
    }
}

void intt_256(uint16_t *y, uint16_t *inv_psis) {
    // cortos_printf("INTT start!");
    
    uint16_t ye[128], yo[128];
    uint16_t i;
    for ( i = 0; i < 128; i++) {
        ye[i] = y[i];
        yo[i] = y[i + 128];
    }
    gs_intt(ye, inv_psis);
    gs_intt(yo, inv_psis);
    for ( i = 0; i < 128; i++) {
        y[2 * i] = ye[i];
        y[2 * i + 1] = yo[i];
    }
}

//QC Passed
////Output is y3 and y1, y2, pwmf are input arrays
void point_wise_mult(uint16_t y3[], uint16_t y1[], uint16_t y2[], uint16_t pwmf[]) {

    // cortos_printf("Point wise multiplication start!");
    

    uint16_t y1e[n], y1o[n], y2e[n], y2o[n], y3e[n], y3o[n];
    uint16_t i;

    // Print the input arrays
    // cortos_printf("Input array y1:\n");
    // for (uint16_t i = 0; i < 256; i++) {
    //     cortos_printf("%u ", y1[i]);
    // }
    // cortos_printf("\n\nInput array y2:\n");
    // for (uint16_t i = 0; i < 256; i++) {
    //     cortos_printf("%u ", y2[i]);
    // }
    // cortos_printf("\n\nInput array pwmf:\n");
    // for (uint16_t i = 0; i < 128; i++) {
    //     cortos_printf("%u ", pwmf[i]);
    // }
    // cortos_printf("\n");
    
    for ( i = 0; i < n; i++) {
        y1e[i] = y1[i];
        y1o[i] = y1[i + n];
        y2e[i] = y2[i];
        y2o[i] = y2[i + n];
    }
    for ( i = 0; i < n; i++) {
        y3e[i] = ((uint32_t)y1e[i] * y2e[i] % q + (uint32_t)y1o[i] * y2o[i] % q * pwmf[i] % q) % q;
        y3o[i] = ((uint32_t)y1e[i] * y2o[i] % q + (uint32_t)y1o[i] * y2e[i] % q) % q;
    }
    for ( i = 0; i < n; i++) {
        y3[i] = y3e[i];
        y3[i + n] = y3o[i];
    }

    // // Print the result
    // cortos_printf("Result of point_wise_mult function:\n");
    // for (uint16_t i = 0; i < 256; i++) {
    //     cortos_printf("%u ", y3[i]);
    // }
    // cortos_printf("\n");

}


//QC Passed
void addr_gen(uint16_t s, uint16_t i, uint16_t l, uint16_t v, uint16_t *ie_r, uint16_t *io_r, uint16_t *iw) {

    // cortos_printf("Addreess Gen start!");
    

    uint16_t j = s >> (l - 1 - i);
    uint16_t z = s & ((v >> i) - 1);
    *ie_r = j * (1 << (l - i)) + z;
    *io_r = *ie_r + (1 << (l - i - 1));
    *iw = (1 << i) + (s >> (l - i - 1));
}

//QC Passed
void ct_ntt(uint16_t *a, uint16_t *psis) {
    // cortos_printf("CT_NTT start!");
    
    uint16_t l = (uint16_t)log2(n);
    uint16_t v = n / 2;
    uint16_t i,s;
    for ( i = 0; i < l; i++) {
        for ( s = 0; s < v; s++) {
            uint16_t ie, io, iw;
            addr_gen(s, i, l, v, &ie, &io, &iw);
            uint16_t S = psis[iw];
            uint16_t U = a[ie];
            uint16_t V = a[io];
            uint16_t x, y;
            butterfly_dit(S, U, V, &x, &y);
            a[ie] = x;
            a[io] = y;
        }
    }
}

void gs_intt(uint16_t *a, uint16_t *inv_psis) {
    // cortos_printf("GT_NTT start!");
    
    uint16_t l = (uint16_t)log2(n);
    uint16_t v = n / 2;
    uint16_t i, s;
    for ( i = 0; i < l; i++) {
        for ( s = 0; s < v; s++) {
            uint16_t i2 = l - i - 1;
            uint16_t ie, io, iw;
            addr_gen(s, i2, l, v, &ie, &io, &iw);
            uint16_t S = inv_psis[iw];
            uint16_t U = a[ie];
            uint16_t V = a[io];
            uint16_t x, y;
            butterfly_dif(S, U, V, &x, &y);
            a[ie] = x;
            a[io] = y;
        }
    }
    for ( i = 0; i < n; i++) {
        a[i] = (uint32_t)a[i] * inv_n % q;
    }
}

//QC Passed
void butterfly_dit(uint16_t w, uint16_t u, uint16_t v, uint16_t *x, uint16_t *y) {
    // cortos_printf("Butterfly_dit start!");
    
    uint16_t v1 = barret_reduction((uint32_t)w * v % q);
    *x = (u + v1) % q;
    *y = (u - v1 + q) % q;
}

void butterfly_dif(uint16_t w, uint16_t u, uint16_t v, uint16_t *x, uint16_t *y) {
    // cortos_printf("Butterfly_dif start!");
    

    *x = (u + v) % q;
    uint16_t y1 = (u - v + q) % q;
    *y = barret_reduction((uint32_t)w * y1 % q);
}

//QC - Passed
uint16_t barret_reduction(uint16_t c1) {
    // cortos_printf("Barret_reduction start!");
    
    uint16_t p = 0;
    uint16_t m = 5039;
    // uint16_t k = 24;
    uint32_t t123 = (uint32_t)m * c1;
    uint16_t t = t123 >> 24;
    uint32_t ta = (uint32_t)p * t;
    uint16_t c = c1 - ta;
    if (c > p) {
        c = c - p;
    }
    return c;
}


int main () 
{	
cortos_printf ("main start\n");
cortos_printf("Crystal_kyber running\n");

    //Loop variables
    uint16_t x, i, j;


    //For Debugging
    // Pre-computed arrays - psis, inv_psis, pwmf
    cortos_printf ("psis start\n");
    uint16_t psis[n] = {
        1, 1729, 2580, 3289, 2642, 630, 1897, 848, 1062, 1919, 193, 797, 2786, 3260, 569, 1746, 296, 2447, 1339, 1476, 3046, 56, 2240, 1333, 1426, 2094, 535, 2882, 2393, 2879, 1974, 821, 289, 331, 3253, 1756, 1197, 2304, 2277, 2055, 650, 1977,
        2513, 632, 2865, 33, 1320, 1915, 2319, 1435, 807, 452, 1438, 2868, 1534, 2402,
        2647, 2617, 1481, 648, 2474, 3110, 1227, 910, 17, 2761, 583, 2649, 1637, 723,
        2288, 1100, 1409, 2662, 3281, 233, 756, 2156, 3015, 3050, 1703, 1651, 2789, 1789,
        1847, 952, 1461, 2687, 939, 2308, 2437, 2388, 733, 2337, 268, 641, 1584, 2298,
        2037, 3220, 375, 2549, 2090, 1645, 1063, 319, 2773, 757, 2099, 561, 2466, 2594,
        2804, 1092, 403, 1026, 1143, 2150, 2775, 886, 1722, 1212, 1874, 1029, 2110, 2935,
        885, 2154
    };

//     for ( x = 0; x < n; x++) {
//         cortos_printf("psis loop counter - %d\n", x);
//         cortos_printf("%d ", psis[x]);
//         cortos_printf("psis loop counter - %d\n", x);
        
//     }
//     cortos_printf("\n");


  cortos_printf ("inv_psis start\n");
    uint16_t inv_psis[n] = {
        1, 1600, 40, 749, 2481, 1432, 2699, 687, 1583, 2760, 69, 543, 2532, 3136,
        1410, 2267, 2508, 1355, 450, 936, 447, 2794, 1235, 1903, 1996, 1089, 3273, 283,
        1853, 1990, 882, 3033, 2419, 2102, 219, 855, 2681, 1848, 712, 682, 927, 1795,
        461, 1891, 2877, 2522, 1894, 1010, 1414, 2009, 3296, 464, 2697, 816, 1352, 2679,
        1274, 1052, 1025, 2132, 1573, 76, 2998, 3040, 1175, 2444, 394, 1219, 2300, 1455,
        2117, 1607, 2443, 554, 1179, 2186, 2303, 2926, 2237, 525, 735, 863, 2768, 1230,
        2572, 556, 3010, 2266, 1684, 1239, 780, 2954, 109, 1292, 1031, 1745, 2688, 3061,
        992, 2596, 941, 892, 1021, 2390, 642, 1868, 2377, 1482, 1540, 540, 1678, 1626,
        279, 314, 1173, 2573, 3096, 48, 667, 1920, 2229, 1041, 2606, 1692, 680, 2746,
        568, 3312
    };
//     for ( x = 0; x < n; x++) {
//         cortos_printf("inv_psis loop counter - %d\n", x);
//         cortos_printf("%u ", inv_psis[x]);
//         cortos_printf("inv_psis loop counter - %d\n", x);
        
//     }

    cortos_printf ("pwmf start\n");
    uint16_t pwmf[n] = {
        17, 3312, 2761, 568, 583, 2746, 2649, 680, 1637, 1692, 723, 2606, 2288, 1041,
        1100, 2229, 1409, 1920, 2662, 667, 3281, 48, 233, 3096, 756, 2573, 2156, 1173,
        3015, 314, 3050, 279, 1703, 1626, 1651, 1678, 2789, 540, 1789, 1540, 1847, 1482,
        952, 2377, 1461, 1868, 2687, 642, 939, 2390, 2308, 1021, 2437, 892, 2388, 941,
        733, 2596, 2337, 992, 268, 3061, 641, 2688, 1584, 1745, 2298, 1031, 2037, 1292,
        3220, 109, 375, 2954, 2549, 780, 2090, 1239, 1645, 1684, 1063, 2266, 319, 3010,
        2773, 556, 757, 2572, 2099, 1230, 561, 2768, 2466, 863, 2594, 735, 2804, 525,
        1092, 2237, 403, 2926, 1026, 2303, 1143, 2186, 2150, 1179, 2775, 554, 886, 2443,
        1722, 1607, 1212, 2117, 1874, 1455, 1029, 2300, 2110, 1219, 2935, 394, 885, 2444,
        2154, 1175
    };
//     for ( x = 0; x < n; x++) {
//         cortos_printf("pwmf loop counter - %d\n", x);
//         cortos_printf("%u ", pwmf[x]);
//         cortos_printf("pwmf loop counter - %d\n", x);
        
//     }
    
    // uint16_t psis[n];
    // uint16_t inv_psis[n];
    // uint16_t pwmf[n];
    
    

    // gen_tf(psis, inv_psis);
    // for ( x = 0; x < n; x++) {
    //     cortos_printf("inv_psis loop counter - %d\n", x);
    //     cortos_printf("%d \n", inv_psis[x]);
    //     cortos_printf("inv_psis loop counter - %d\n", x);
    // }
    // for ( x = 0; x < n; x++) {
    //     cortos_printf("psis loop counter - %d\n", x);
    //     cortos_printf("%d \n", psis[x]);
    //     cortos_printf("psis loop counter - %d\n", x);
    // }

    // gen_pwmf(pwmf);
    // Print the PWMF array
    // cortos_printf(" Inside Function, PWMF array:\n");
    // for (x = 0; x < n; x++) {
    //     cortos_printf("%u ", pwmf[x]);
    // }
    // cortos_printf("\n");

    cortos_printf("Generating Private and Public Keys\n");
//*********************************************************************/
    // Generate Private Key (s) and Public Key (b)
//*********************************************************************/    
    //For debugging
    //Pre-computed arrays scaap and bcap
    //Private key
    // uint16_t scap[2][256] = {
    //                          {1291, 53, 170, 2072, 1204, 1473, 972, 344, 2474, 2826, 1913, 1328, 207, 3308, 2032, 1126, 652, 1853, 1640, 493, 377, 2634, 1552, 1406, 2509, 483, 3270, 912, 906, 3062, 93, 691, 1306, 2172, 2824, 515, 2604, 1391, 1289, 3296, 3166, 2913, 1957, 2062, 2495, 822, 1027, 168, 2510, 2211, 2062, 445, 1536, 589, 1045, 1286, 165, 2948, 638, 2409, 2628, 2726, 2681, 1987, 1401, 63, 47, 2475, 555, 1508, 1595, 1353, 1843, 722, 2410, 1852, 776, 87, 2773, 3026, 2318, 3160, 2749, 1442, 2034, 1947, 1131, 3129, 853, 874, 129, 1840, 491, 2692, 87, 1908, 1995, 1526, 2986, 1887, 3184, 1327, 1455, 274, 2819, 636, 2161, 2927, 1269, 2622, 35, 697, 1679, 1603, 2809, 708, 3268, 2789, 3024, 2278, 407, 3132, 1772, 668, 21, 551, 2927, 1822, 291, 478, 1234, 3269, 2244, 2729, 3238, 3040, 950, 2455, 1668, 2012, 1452, 2069, 501, 683, 867, 981, 1594, 3293, 1611, 767, 323, 704, 1456, 432, 2369, 2029, 1388, 617, 1580, 2923, 1956, 2341, 683, 1397, 3321, 1413, 537, 12, 383, 2109, 1167, 1656, 2022, 2941, 2641, 1365, 1595, 1886, 2695, 811, 1949, 1380, 3324, 1326, 887, 3300, 1084, 2661, 2532, 560, 237, 3174, 93, 2943, 1742, 2460, 555, 1344, 392, 344, 2409, 766, 2900, 2800, 670, 1307, 2675, 958, 220, 2931, 3045, 2278, 2130, 2671, 1310, 2949, 3297, 2573, 2784, 1640, 2433, 2284, 719, 2997, 1483, 348, 88, 1345, 1389, 2554, 3284, 75, 1426, 482, 3220, 1944, 2723, 3004, 823, 1046, 1221, 2920, 2867, 1547, 2229, 2394, 3303, 1417, 1906, 936, 2820, 2351, 2747, 3203, 3278, 2245}, 
    //                          {367, 1164, 2329, 2251, 1703, 2669, 648, 2840, 297, 2253, 2389, 3152, 1642, 2046, 1469, 1183, 2663, 824, 1967, 2814, 765, 563, 2241, 2617, 1222, 2583, 465, 1864, 3179, 539, 2824, 2405, 1757, 44, 574, 380, 702, 682, 2468, 1185, 3204, 400, 846, 394, 1767, 1366, 1636, 2873, 2176, 2558, 2450, 2203, 1995, 1250, 984, 2205, 975, 2381, 3035, 934, 2674, 812, 753, 1056, 1619, 672, 2938, 1084, 2792, 990, 2587, 787, 458, 2473, 1178, 221, 3075, 1096, 443, 2276, 694, 1109, 371, 1126, 2459, 2208, 2855, 3119, 688, 447, 2315, 2666, 2000, 1155, 2145, 618, 778, 2221, 1959, 32, 3121, 2358, 600, 1932, 124, 2986, 3242, 3058, 1511, 3325, 2288, 1929, 1770, 888, 1008, 1020, 1093, 2479, 263, 1108, 1736, 792, 1193, 731, 2047, 915, 1817, 2339, 2599, 755, 2367, 686, 702, 2148, 2651, 1738, 2120, 3168, 1528, 3141, 2234, 2179, 2077, 3127, 3051, 1560, 821, 1923, 2705, 2370, 72, 1902, 3235, 2442, 2637, 221, 2961, 62, 1725, 2961, 7, 1242, 3005, 275, 1971, 809, 736, 872, 960, 2445, 2451, 51, 361, 2267, 2680, 709, 2429, 1520, 2533, 1178, 2415, 2474, 3063, 970, 768, 71, 2431, 2140, 1166, 796, 1548, 1441, 2921, 129, 1420, 17, 2440, 1993, 2434, 2847, 1629, 2894, 1478, 1101, 789, 2292, 2873, 1014, 1447, 1431, 1494, 1474, 1816, 1992, 2317, 105, 1538, 2591, 1872, 2168, 1026, 565, 210, 1833, 1055, 1025, 3008, 2571, 606, 1534, 3276, 3079, 3239, 225, 2292, 789, 2695, 1515, 2552, 64, 2424, 2894, 261, 2096, 2241, 930, 3256, 2722, 1961, 2094, 476, 1917, 689, 810, 34, 1710}
    //                          };

    // //Public Key
    // uint16_t bcap[2][256] = {
    //                             {778,  423, 3122,  879, 2252, 1793, 2000, 2772,  215, 2994, 3292, 1001,  215, 2047, 2792, 2356, 1778, 3111,  554, 1692, 1488, 2701, 839,  182, 3289,  417, 3039, 2664, 2875, 2682, 2222, 2590,  294,2483,  487, 2777, 1879,  684,  528,  964, 2202, 2988, 1621, 1421,1769, 2512, 2287, 1620, 2604, 2581, 2350, 1814, 1712, 2638, 2568,3236,  113, 1700, 1787, 2217, 2964,  127, 2884, 2766, 1971, 2412, 250,  431, 2607,  577, 2129, 1538, 1945, 1202,  487, 1630,  130,1021, 2465, 1043, 1483, 1501, 1449, 2089, 2006, 3115,  165,  882,1509, 3189,  166, 1921,  821, 1170, 1676, 2127, 1189, 2182,   99,2025, 1074, 2175, 1479, 1532, 1637, 1268, 2035,  704, 2365, 2645,1411,  870, 1717, 3158, 2223, 1963,  131, 1393, 2098, 1090, 2366,2799, 1801,  303, 3159, 1433,  286,  610, 2608,  275, 3224, 2438,1909,  197, 1419, 1395, 1294,  566,  976,  990, 1605,  424, 1288,2726, 1243, 1729, 2505, 1503, 2630,  304, 1953, 3065,  462, 2481, 457, 3003, 2662, 1135,   75, 2620, 2900, 1311, 2713, 2306, 1461,2630,  591, 1401, 1578, 1755,  737,  485,  194, 1361, 2079, 1441,1967, 1965,  804, 1392, 1759, 2834, 1299,  266,   98, 2466, 2882,1327, 3139, 2222, 3206,  577,  236, 3173, 2589, 2847, 1224, 3057,1574, 1300, 2183,  176,  423, 2743, 3243, 2129, 1887,  460,  778, 656, 1007, 2865, 1706, 1797, 2792, 2128,  803, 1566, 2793, 1714, 397, 1241, 2871, 2785,  648,  670, 2919, 3165, 2627, 1249,   62, 476,  606,  354,   72, 2027, 1975,  500,  212, 1841, 2370,  709,1743, 1244, 2994, 2808,  661,  917,  501, 2429, 1504, 1564,  731,2132, 1832,  555},
    //                         {
    //                             2690, 1578,  187, 2388, 1811,  411,  344,  796, 1249, 3157,  453, 3177, 2524, 2678, 2199,  856, 1472, 2902, 2750,  414,  338, 2824, 1878,  153,  186, 1440, 3233, 1041,  647,  178,  626, 1534, 2364, 2942, 1939, 2026, 1947,  140, 2911,  739, 1327,  562, 1249,  641, 1254, 1139, 1102,  622,  129, 1109, 2454, 2071,  745, 1654, 1812, 2676, 2717,  971,  309, 2261, 2410, 1956, 3172, 1203, 1463, 2788, 2280,  726, 1380, 1789, 1804,  267, 2822,  199, 1672, 2758, 2570,  524,  736, 1255, 3175,  129,  234, 2520,  897, 2747, 3052, 2239, 1412, 2406, 2012, 1446, 1345,  349, 2311, 1134, 2752,  162,  946, 1300, 3124, 2758,  457,  992, 1546, 2355, 3236, 1940,    0, 1225, 1390,   47, 2126,  645,  436,  574, 1942, 1928,  232, 2670, 1445, 1463, 2439, 2669,  679, 2515, 2386, 1955, 1870, 1489,  383,  694, 2536, 1483,  208, 2413, 3053, 1737, 1921, 3248, 3289, 1544, 2507, 2717, 1414,  706, 2278, 1983,  449, 1214, 2015,  829, 1504, 2808,   71, 1410,  811, 1811, 1050, 3216, 1433,  486, 2973, 1111, 1181,   40, 1150, 2994, 3021, 2423, 1608, 2959, 2389, 2700,  240, 1215, 3079, 2880, 2125,   34, 2806, 2565, 2757,  401, 1030, 1775, 1508, 1223,  633, 1101, 1306, 2678,  871, 2989, 1174, 2989, 3195, 1954, 1797,  885, 2741, 2682, 2969, 1862, 2363, 1297, 3156, 2085, 2206, 2231, 2534, 3149, 2785, 2985, 1518, 3134, 1649,  647, 2787, 1887,  465, 1462, 1524,  215,  790, 3316, 2391, 2429, 1513,  193,  868,  743, 2808,  356, 2094,  516, 2207,  542,  310, 2353, 1768, 3306, 1177, 2104, 1985,  141,  349,  357, 2240, 3315, 3101, 1839, 1664, 1924,  122, 3038
    //                         } 
    //                         };



    
    cortos_printf("Key_gen start! (int main)\n");
    cortos_printf("Storing array a[2][2][256]\n");


    uint16_t a_0_0[256] = {2166, 55, 2412, 1319, 1264, 1057, 1758, 1217, 1318, 2071, 3101, 2975, 692, 3192, 388, 351, 102, 299, 216, 3167, 1608, 2685, 693, 352, 746, 528, 359, 721, 528, 667, 310, 30, 18, 426, 710, 2019, 1040, 295, 1108, 2849, 279, 37, 2807, 1852, 2456, 3309, 2417, 490, 2648, 1133, 1711, 8, 2227, 161, 2404, 1947, 2576, 446, 2451, 395, 1366, 2250, 625, 3139, 577, 1803, 513, 1725, 2951, 619, 417, 502, 2905, 3078, 2959, 2961, 2798, 644, 1944, 79, 12, 1449, 1583, 589, 2765, 1474, 154, 2124, 887, 365, 109, 1011, 910, 2014, 2619, 1175, 1083, 18, 518, 2448, 1018, 633, 79, 879, 303, 848, 2700, 2423, 692, 467, 1545, 3022, 232, 2415, 1537, 1305, 2878, 640, 2369, 1963, 61, 1375, 657, 253, 520, 2715, 1879, 3271, 604, 179, 1273, 93, 638, 86, 2767, 1776, 2609, 374, 502, 227, 408, 613, 1252, 2548, 808, 1817, 2831, 873, 3144, 1127, 67, 102, 6, 2507, 2367, 41, 2687, 1230, 364, 83, 3241, 2748, 1393, 3248, 2454, 1270, 2275, 2368, 492, 1658, 1744, 302, 2668, 3308, 2387, 824, 600, 681, 695, 506, 2340, 1746, 162, 123, 555, 1848, 1823, 2512, 3092, 1874, 1548, 162, 1279, 127, 1787, 2411, 69, 646, 1158, 2106, 22, 681, 26, 1522, 1649, 1511, 439, 2194, 1986, 1015, 2098, 3265, 551, 2961, 2791, 547, 159, 1815, 1927, 2455, 1117, 2726, 2728, 444, 2431, 1567, 477, 3063, 954, 728, 59, 3212, 1428, 214, 1242, 2022, 226, 3074, 694, 1916, 97, 3103, 2143, 355, 718, 1920, 1058, 372, 2854, 2373, 2647, 2663, 2529, 1703, 1801, 1751};
    uint16_t a_0_1[256] = {832, 1128, 2541, 353, 3125, 2561, 970, 1541, 213, 1258, 747, 2510, 408, 551, 2993, 1537, 2545, 73, 1308, 504, 1161, 1599, 1315, 2282, 177, 1170, 760, 3179, 1935, 196, 801, 61, 2708, 1798, 1209, 2901, 7, 865, 286, 3002, 46, 2983, 534, 47, 1507, 1750, 1027, 897, 2704, 1236, 167, 532, 17, 721, 476, 193, 2014, 872, 1436, 426, 491, 1729, 2496, 58, 71, 2211, 2792, 833, 741, 1105, 3253, 32, 472, 208, 434, 183, 408, 1858, 576, 179, 1544, 1986, 2013, 346, 14, 3222, 2073, 2391, 1027, 34, 2355, 803, 444, 274, 1579, 2403, 532, 2500, 1236, 2143, 725, 1867, 764, 351, 3130, 371, 1152, 3264, 2085, 2945, 2632, 1608, 3270, 2803, 203, 3125, 2671, 599, 2562, 1226, 3266, 3026, 78, 635, 1277, 1645, 377, 973, 196, 1516, 1785, 2198, 1738, 2561, 2831, 993, 402, 1114, 53, 2951, 977, 2483, 2849, 2903, 3310, 530, 1072, 1274, 1024, 1695, 843, 3180, 2502, 1519, 198, 2, 190, 380, 1917, 676, 1621, 2974, 1410, 1990, 1034, 137, 92, 594, 572, 2584, 59, 3153, 1442, 1470, 1039, 18, 2670, 1460, 748, 240, 370, 547, 2942, 149, 746, 585, 134, 289, 394, 519, 2329, 2806, 534, 1956, 39, 474, 840, 2403, 157, 2659, 405, 455, 1053, 2508, 1883, 1759, 1404, 3042, 386, 1026, 2919, 1108, 1825, 3007, 410, 1461, 2176, 767, 1422, 2929, 1378, 526, 447, 756, 2625, 2552, 1760, 299, 1731, 740, 154, 1987, 3125, 2095, 2326, 1871, 491, 1400, 949, 1068, 237, 1914, 937, 3316, 1287, 318, 120, 1831, 2298, 696, 2552, 59, 2125, 2810, 46, 189};
    uint16_t a_1_0[256] = {755, 1876, 2529, 2076, 527, 2098, 887, 336, 2216, 1716, 877, 112, 2556, 619, 419, 458, 523, 2865, 418, 2418, 1928, 1099, 2046, 2615, 1389, 2498, 1657, 2896, 2763, 82, 562, 1191, 2572, 2702, 1149, 3219, 154, 472, 611, 2996, 306, 2178, 3186, 1266, 2873, 485, 1674, 479, 2303, 379, 2954, 1751, 641, 2967, 599, 2393, 520, 620, 2053, 413, 1278, 3207, 645, 1616, 1596, 2514, 904, 609, 601, 70, 317, 2269, 248, 3241, 3111, 15, 433, 1694, 213, 1569, 566, 2813, 827, 1707, 411, 1380, 726, 2145, 1642, 763, 35, 283, 1993, 1042, 45, 2586, 1833, 513, 3021, 1616, 1522, 1272, 389, 1631, 59, 2138, 642, 2099, 2763, 3047, 3135, 1388, 416, 2972, 413, 1525, 3011, 270, 2652, 844, 1421, 1422, 1505, 1548, 1852, 437, 1161, 1588, 1300, 921, 2161, 2908, 1425, 875, 703, 2646, 276, 743, 59, 735, 3155, 2884, 125, 2988, 315, 444, 746, 2049, 2456, 1064, 1292, 1358, 596, 1073, 55, 578, 1923, 80, 2106, 646, 2999, 3218, 2301, 275, 1347, 1364, 516, 3004, 1368, 956, 753, 340, 2236, 1785, 216, 508, 107, 297, 1309, 1945, 861, 1775, 2031, 516, 2658, 1637, 2261, 3163, 2737, 3090, 1345, 1841, 2880, 682, 87, 464, 70, 2530, 2045, 997, 1180, 1693, 1992, 3202, 2456, 2955, 1575, 1304, 384, 2612, 804, 1174, 1448, 1085, 366, 1780, 3152, 668, 2140, 237, 676, 320, 2266, 1066, 267, 2959, 281, 1002, 2948, 2121, 529, 2984, 488, 291, 719, 398, 1047, 233, 78, 2872, 2931, 388, 2865, 434, 1812, 603, 2248, 1739, 3181, 286, 595, 3301, 3226, 600, 2579, 1172};
    uint16_t a_1_1[256] = {344, 839, 2342, 201, 1268, 767, 878, 3133, 2064, 1638, 2368, 1320, 1140, 1598, 1211, 1903, 178, 2729, 1509, 2590, 1424, 354, 1638, 139, 464, 305, 1103, 1521, 3226, 2046, 1730, 370, 1130, 486, 1658, 3102, 321, 1261, 2127, 2974, 595, 2266, 848, 1277, 490, 617, 2075, 170, 2449, 2352, 334, 201, 20, 3269, 2688, 1759, 955, 254, 137, 1560, 1871, 1455, 2324, 1332, 108, 3111, 118, 2513, 316, 1487, 395, 674, 1335, 3208, 717, 1148, 620, 2259, 984, 593, 2641, 779, 1473, 1340, 1218, 2259, 716, 455, 558, 1106, 2278, 589, 673, 330, 1622, 2659, 343, 958, 164, 597, 3132, 812, 1262, 2488, 1119, 2808, 1861, 218, 1282, 2340, 3052, 575, 3219, 54, 379, 100, 2519, 253, 486, 2902, 2935, 31, 2406, 1245, 1326, 1378, 927, 2994, 3060, 1400, 582, 555, 2238, 2167, 2185, 1700, 1588, 362, 2499, 2111, 564, 598, 1499, 1471, 624, 2886, 2042, 520, 185, 1220, 1719, 54, 469, 1151, 841, 608, 530, 2268, 2155, 329, 1538, 469, 1400, 3077, 1081, 353, 1038, 1628, 1508, 278, 3185, 964, 2125, 1517, 2262, 380, 359, 1035, 2816, 142, 2975, 726, 1679, 516, 874, 2856, 407, 606, 304, 2137, 218, 2204, 568, 2793, 1148, 3030, 518, 302, 3123, 573, 2267, 2161, 391, 902, 26, 1072, 2429, 1979, 2228, 2333, 3060, 155, 1897, 701, 2833, 3184, 1367, 776, 2195, 1031, 2745, 1755, 654, 369, 2336, 2427, 664, 3005, 860, 3118, 496, 3267, 1177, 2348, 651, 2751, 2060, 2669, 187, 2085, 1193, 141, 3254, 531, 321, 2385, 2400, 1839, 2045, 710, 3311, 3281, 3162, 647, 1467, 933};

    cortos_printf("Storing array e[2][2][256]\n");

    uint16_t e_0[256] = {3328, 1, 1, 0, 3328, 0, 3328, 0, 3328, 0, 0, 1, 2, 1, 1, 3328, 3328, 3327, 1, 2, 0, 3328, 2, 2, 3328, 2, 3328, 2, 3328, 3328, 3328, 0, 3328, 0, 3328, 0, 3328, 0, 0, 2, 0, 0, 1, 3327, 3328, 3328, 0, 3328, 1, 1, 1, 1, 3327, 0, 2, 0, 0, 0, 0, 1, 2, 3328, 0, 3328, 3328, 3328, 3, 1, 3327, 0, 3328, 0, 1, 0, 1, 1, 0, 3328, 3328, 3327, 1, 0, 1, 3327, 0, 3326, 3327, 2, 3328, 0, 0, 1, 0, 3326, 3328, 1, 3328, 1, 1, 1, 3328, 2, 2, 0, 2, 3327, 0, 3328, 0, 1, 1, 0, 3328, 3326, 3327, 3326, 2, 3327, 0, 0, 2, 3328, 3328, 0, 3327, 0, 0, 0, 0, 3328, 1, 0, 0, 3327, 3326, 1, 3326, 0, 3328, 2, 3327, 2, 3328, 2, 3328, 2, 0, 0, 3327, 3328, 3328, 1, 0, 1, 1, 2, 3327, 2, 0, 0, 0, 2, 1, 0, 3326, 3328, 2, 1, 3328, 3328, 3328, 3326, 3328, 0, 2, 1, 3327, 0, 0, 2, 1, 1, 2, 0, 0, 0, 3327, 1, 1, 3328, 3328, 2, 0, 0, 1, 1, 3327, 3, 3328, 2, 1, 3327, 0, 3328, 0, 0, 0, 2, 3328, 0, 0, 1, 0, 0, 1, 1, 3327, 3328, 1, 0, 0, 1, 2, 2, 3328, 0, 3328, 0, 3327, 1, 1, 0, 0, 3328, 0, 1, 1, 0, 2, 3328, 3328, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 3327, 0, 3328, 1, 0};
    uint16_t e_1[256] = {1, 1, 3328, 3328, 3, 1, 3328, 0, 0, 0, 1, 1, 3328, 0, 0, 3328, 1, 3328, 2, 3328, 3327, 1, 3328, 3326, 3328, 0, 3328, 2, 1, 3, 0, 1, 1, 3328, 0, 3328, 3326, 3328, 0, 1, 0, 1, 0, 2, 0, 3328, 0, 1, 0, 3328, 3328, 0, 2, 2, 3327, 0, 2, 1, 3328, 0, 3327, 3328, 2, 3327, 1, 0, 1, 0, 3328, 3327, 2, 1, 3327, 1, 0, 1, 1, 0, 3327, 3328, 3328, 1, 3328, 2, 1, 1, 3328, 0, 1, 2, 2, 1, 0, 3328, 0, 3327, 3327, 1, 1, 3328, 1, 3327, 1, 2, 1, 0, 3328, 2, 1, 0, 2, 0, 0, 0, 3328, 3328, 1, 3328, 1, 0, 3328, 0, 3328, 3328, 0, 3328, 2, 2, 3327, 1, 3328, 2, 1, 3328, 3328, 1, 1, 0, 3328, 0, 3328, 0, 1, 3328, 0, 3328, 1, 3328, 0, 3327, 3328, 3327, 0, 3328, 3328, 1, 2, 0, 2, 0, 1, 0, 3328, 3328, 1, 0, 2, 3328, 3327, 3327, 3328, 3328, 2, 3328, 2, 1, 1, 3327, 0, 3328, 3327, 3327, 0, 3, 3327, 0, 0, 2, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 2, 3327, 0, 1, 3327, 1, 1, 1, 1, 0, 1, 0, 0, 3327, 2, 3328, 0, 0, 0, 2, 0, 2, 0, 3326, 3327, 1, 1, 3328, 2, 3328, 3328, 0, 1, 0, 3328, 0, 3328, 3327, 0, 3327, 0, 0, 3328, 0, 1, 0, 0, 1, 3328, 3328, 3328, 1, 3328, 2, 0, 3328, 0, 1};
                            
    cortos_printf("Storing array s[2][2][256]\n");

    uint16_t s_0[256] = {0, 1, 0, 0, 0, 0, 1, 3327, 0, 3328, 3328, 1, 2, 1, 3328, 1, 1, 0, 3328, 0, 1, 0, 3326, 3328, 1, 3327, 2, 0, 1, 1, 0, 0, 3328, 3328, 1, 3328, 1, 0, 0, 3328, 2, 2, 3327, 1, 2, 0, 0, 1, 0, 0, 0, 0, 1, 3328, 1, 1, 0, 0, 0, 0, 1, 1, 3328, 1, 0, 0, 1, 3328, 0, 0, 2, 0, 0, 0, 3328, 3327, 3327, 0, 3328, 3328, 0, 3327, 1, 3328, 1, 3328, 0, 2, 0, 3327, 1, 0, 1, 1, 0, 0, 3327, 3328, 0, 1, 0, 0, 3328, 0, 0, 3328, 3328, 0, 3328, 3327, 1, 1, 3328, 0, 1, 1, 3328, 0, 3328, 3326, 0, 0, 3328, 0, 2, 3328, 0, 1, 0, 0, 2, 3328, 0, 3328, 3328, 0, 0, 0, 1, 2, 3328, 3327, 1, 0, 2, 2, 2, 3327, 2, 0, 0, 1, 0, 3328, 3328, 0, 1, 0, 0, 0, 3328, 3328, 1, 3, 3328, 1, 3328, 2, 0, 0, 0, 2, 0, 1, 1, 3328, 1, 0, 3328, 3328, 0, 3328, 3328, 1, 3328, 3327, 1, 0, 1, 3328, 1, 3328, 1, 3328, 1, 0, 3327, 3328, 1, 3, 3327, 0, 1, 3327, 3, 0, 1, 1, 1, 1, 3327, 3328, 3328, 3328, 1, 3326, 0, 1, 1, 1, 0, 0, 1, 0, 0, 2, 0, 3328, 3328, 3328, 1, 3, 3328, 0, 3328, 2, 1, 3327, 0, 1, 1, 0, 3327, 3328, 1, 1, 0, 3328, 3328, 3328, 0, 3328, 0, 0, 3328, 0};
    uint16_t s_1[256] = {2, 1, 0, 3327, 0, 0, 0, 1, 0, 0, 0, 0, 3328, 0, 0, 3328, 1, 1, 3328, 1, 1, 0, 0, 1, 0, 3328, 3328, 1, 0, 1, 0, 0, 3328, 0, 0, 1, 1, 1, 0, 3, 0, 0, 1, 3328, 0, 0, 1, 3328, 1, 3328, 0, 3327, 3328, 1, 0, 3328, 0, 0, 0, 0, 0, 0, 3328, 3328, 0, 1, 0, 0, 0, 0, 2, 3328, 1, 1, 2, 0, 2, 0, 3328, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 3328, 0, 3328, 3327, 1, 0, 1, 0, 2, 1, 0, 1, 0, 3328, 0, 3327, 1, 1, 0, 3327, 3328, 1, 2, 0, 1, 3328, 3328, 0, 0, 3328, 1, 3327, 0, 1, 3327, 2, 1, 1, 3327, 0, 3327, 0, 0, 0, 1, 1, 0, 3328, 0, 0, 3327, 3328, 0, 3328, 3, 1, 0, 3327, 1, 1, 2, 2, 1, 1, 2, 0, 2, 0, 0, 1, 3328, 1, 0, 0, 2, 3327, 3327, 3328, 0, 0, 3327, 0, 1, 0, 0, 3328, 3327, 0, 3328, 1, 1, 2, 0, 0, 3328, 0, 2, 3328, 0, 3326, 2, 2, 0, 3328, 1, 3328, 2, 3328, 3326, 0, 1, 3328, 3328, 0, 2, 3328, 0, 0, 2, 0, 1, 0, 0, 1, 3328, 1, 0, 2, 1, 0, 3328, 0, 0, 3328, 0, 0, 2, 3328, 3327, 0, 0, 0, 3328, 0, 3328, 2, 3328, 3327, 3327, 3328, 2, 3327, 3328, 1, 3328, 3327, 1, 0, 0, 3327, 3327, 0, 3327, 0, 1, 3328, 1};


    cortos_printf("Key_gen start! (int main)\n");
    // Step 3: Compute NTT for s and e
    ntt_256(s_0, psis);
    ntt_256(s_1, psis); 
    ntt_256(e_0, psis);
    ntt_256(e_1, psis);

    // Step 4: Compute tcap
    uint16_t tcap_0_0[256];
    uint16_t tcap_0_1[256];
    uint16_t tcap_1_0[256];
    uint16_t tcap_1_1[256];

    cortos_printf("Point wise multiplication start!");
    
    // point_wise_mult(tcap_0_0, a_0_0, s_0, pwmf);     
    uint16_t y1e[n], y1o[n], y2e[n], y2o[n], y3e[n], y3o[n];
    for ( i = 0; i < n; i++) {
        y1e[i] = a_0_0[i];
        y1o[i] = a_0_0[i + n];
        y2e[i] = s_0[i];
        y2o[i] = s_0[i + n];
    }
    for ( i = 0; i < n; i++) {
        y3e[i] = ((uint32_t)y1e[i] * y2e[i] % q + (uint32_t)y1o[i] * y2o[i] % q * pwmf[i] % q) % q;
        y3o[i] = ((uint32_t)y1e[i] * y2o[i] % q + (uint32_t)y1o[i] * y2e[i] % q) % q;
    }
    for ( i = 0; i < n; i++) {
        tcap_0_0[i] = y3e[i];
        tcap_0_0[i + n] = y3o[i];
    }

    // point_wise_mult(tcap_0_1, a_0_1, s_1, pwmf);
    for ( i = 0; i < n; i++) {
        y1e[i] = a_0_1[i];
        y1o[i] = a_0_1[i + n];
        y2e[i] = s_1[i];
        y2o[i] = s_1[i + n];
    }
    for ( i = 0; i < n; i++) {
        y3e[i] = ((uint32_t)y1e[i] * y2e[i] % q + (uint32_t)y1o[i] * y2o[i] % q * pwmf[i] % q) % q;
        y3o[i] = ((uint32_t)y1e[i] * y2o[i] % q + (uint32_t)y1o[i] * y2e[i] % q) % q;
    }
    for ( i = 0; i < n; i++) {
        tcap_0_1[i] = y3e[i];
        tcap_0_1[i + n] = y3o[i];
    }
    

    // point_wise_mult(tcap_1_0, a_1_0, s_0, pwmf);
     for ( i = 0; i < n; i++) {
        y1e[i] = a_1_0[i];
        y1o[i] = a_1_0[i + n];
        y2e[i] = s_0[i];
        y2o[i] = s_0[i + n];
    }
    for ( i = 0; i < n; i++) {
        y3e[i] = ((uint32_t)y1e[i] * y2e[i] % q + (uint32_t)y1o[i] * y2o[i] % q * pwmf[i] % q) % q;
        y3o[i] = ((uint32_t)y1e[i] * y2o[i] % q + (uint32_t)y1o[i] * y2e[i] % q) % q;
    }
    for ( i = 0; i < n; i++) {
        tcap_1_0[i] = y3e[i];
        tcap_1_0[i + n] = y3o[i];
    }
    

    // point_wise_mult(tcap_1_1, a_1_1, s_1, pwmf);
    for ( i = 0; i < n; i++) {
        y1e[i] = a_1_1[i];
        y1o[i] = a_1_1[i + n];
        y2e[i] = s_1[i];
        y2o[i] = s_1[i + n];
    }
    for ( i = 0; i < n; i++) {
        y3e[i] = ((uint32_t)y1e[i] * y2e[i] % q + (uint32_t)y1o[i] * y2o[i] % q * pwmf[i] % q) % q;
        y3o[i] = ((uint32_t)y1e[i] * y2o[i] % q + (uint32_t)y1o[i] * y2e[i] % q) % q;
    }
    for ( i = 0; i < n; i++) {
        tcap_1_1[i] = y3e[i];
        tcap_1_1[i + n] = y3o[i];
    }
    
    uint16_t scap_0[256];
    uint16_t scap_1[256];
    uint16_t bcap_0[256];
    uint16_t bcap_1[256];

    // Step 5: Compute bcap
    for ( i = 0; i < 256; i++) {
        bcap_0[i] = ((tcap_0_0[i] + tcap_0_1[i]) + e_0[i]) % q;
        bcap_1[i] = ((tcap_1_0[i] + tcap_1_1[i]) + e_1[i]) % q;
    }

    // Compute scap
    for ( i = 0; i < 256; i++) {
        scap_0[i] = s_0[i];
        scap_1[i] = s_1[i];
    }

    cortos_printf ("keygen end, it gives scap[2][256] and bcap[2][256]\n");
     // Display private key (scap) and public key (bcap)
    // cortos_printf("Private Key (scap_0):\n");
    // for ( j = 0; j < 256; j++) {
    //     cortos_printf("%u ", scap_0[j]);
    // }
    // cortos_printf("\n");

    // cortos_printf("Private Key (scap_1):\n");
    // for ( j = 0; j < 256; j++) {
    //     cortos_printf("%u ", scap_1[j]);
    // }
    // cortos_printf("\n");
    
    // cortos_printf("Private Key (bcap_0):\n");
    // for ( j = 0; j < 256; j++) {
    //     cortos_printf("%u ", bcap_0[j]);
    // }
    // cortos_printf("\n");
        
    // cortos_printf("Private Key (bcap_0):\n");
    // for ( j = 0; j < 256; j++) {
    //     cortos_printf("%u ", bcap_0[j]);
    // }
    // cortos_printf("\n");
    
    // cortos_printf("%d \n", bcap_0[0]);
    // cortos_printf("%d \n", bcap_0[255]);
    
    cortos_printf ("keygen end, it gives scap[2][256] and bcap[2][256]\n");
     

    CORTOS_DEBUG("Int main End!!");
    return 0;

}
