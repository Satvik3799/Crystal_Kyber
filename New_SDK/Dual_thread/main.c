#include <stdbool.h>
#include <assert.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <math.h>

#include <cortos.h>
#include <thread_channel.h>
#include <ajit_access_routines.h>

//satvik headers
#include "Crystal_Kyber.h"
#include "utils.h"
#include "ntt.h"
#include "intt.h"

// Define necessary constants
#define q 3329
#define n2 256
#define n 128
#define inv_n 3303
#define psin 17
#define inv_psin 1175
#define k 2

volatile ThreadChannel volatile tc;


void setup()
{
	__ajit_serial_configure__(1,0,0);
	__ajit_serial_set_baudrate__ (115200, 80000000);
	__ajit_serial_set_uart_reset__ (0);

	// cortos_printf("Init channel.\n");
	// initialize scoreboard.
	initChannel(&tc, 1);

	// cortos_printf("initChannel %d: status=%d.\n", tc.id, tc.status);
}


//Main fxn Thread 0
uint8_t main_00()
{

    uint16_t i,j;

    uint64_t t00_0;
    uint64_t t00_1;

    // Generate pre-computed factors

    uint16_t psis[128], inv_psis[128], pwmf[128];
    gen_pwmf(pwmf);

    gen_tf(psis, inv_psis);

    cortos_printf("\n[INFO]         :           Twiddle factors generated.\n");

    // // Print the PWMF array
    // cortos_printf("[INFO]           :           PWMF array:\n");
    // for (i = 0; i < n; i++) {
    //     cortos_printf("%u ", pwmf[i]);
    // }
    // cortos_printf("\n");
    
    // //  Print the PSIS array
    // cortos_printf("[INFO]           :           PSIS array\n");
    // for (i = 0; i < 128; i++) {
    //     cortos_printf("%u, ", psis[i]);
    // }
    // cortos_printf("\n");

    // // Print the INV_PSIS array
    // cortos_printf("[INFO]           :           INV_PSIS array:\n");
    // for (i = 0; i < n; i++) {
    //     cortos_printf("%u ", inv_psis[i]);
    // }
    // cortos_printf("\n");
    
    

    //------------------------ To Test (Begin) ------------------------//
    // Allocate memory for the twiddle factors and point-wise multiplication factors
    // uint16_t psis[128] = {
    //     1, 1729, 2580, 3289, 2642, 630, 1897, 848, 1062, 1919, 193, 797, 2786, 3260, 569, 1746, 296, 2447, 1339, 1476, 3046, 56, 2240, 1333, 1426, 2094, 535, 2882, 2393, 2879, 1974, 821, 289, 331, 3253, 1756, 1197, 2304, 2277, 2055, 650, 1977,
    //     2513, 632, 2865, 33, 1320, 1915, 2319, 1435, 807, 452, 1438, 2868, 1534, 2402,
    //     2647, 2617, 1481, 648, 2474, 3110, 1227, 910, 17, 2761, 583, 2649, 1637, 723,
    //     2288, 1100, 1409, 2662, 3281, 233, 756, 2156, 3015, 3050, 1703, 1651, 2789, 1789,
    //     1847, 952, 1461, 2687, 939, 2308, 2437, 2388, 733, 2337, 268, 641, 1584, 2298,
    //     2037, 3220, 375, 2549, 2090, 1645, 1063, 319, 2773, 757, 2099, 561, 2466, 2594,
    //     2804, 1092, 403, 1026, 1143, 2150, 2775, 886, 1722, 1212, 1874, 1029, 2110, 2935,
    //     885, 2154
    // };
    // uint16_t inv_psis[128] = {
    //     1, 1600, 40, 749, 2481, 1432, 2699, 687, 1583, 2760, 69, 543, 2532, 3136,
    //     1410, 2267, 2508, 1355, 450, 936, 447, 2794, 1235, 1903, 1996, 1089, 3273, 283,
    //     1853, 1990, 882, 3033, 2419, 2102, 219, 855, 2681, 1848, 712, 682, 927, 1795,
    //     461, 1891, 2877, 2522, 1894, 1010, 1414, 2009, 3296, 464, 2697, 816, 1352, 2679,
    //     1274, 1052, 1025, 2132, 1573, 76, 2998, 3040, 1175, 2444, 394, 1219, 2300, 1455,
    //     2117, 1607, 2443, 554, 1179, 2186, 2303, 2926, 2237, 525, 735, 863, 2768, 1230,
    //     2572, 556, 3010, 2266, 1684, 1239, 780, 2954, 109, 1292, 1031, 1745, 2688, 3061,
    //     992, 2596, 941, 892, 1021, 2390, 642, 1868, 2377, 1482, 1540, 540, 1678, 1626,
    //     279, 314, 1173, 2573, 3096, 48, 667, 1920, 2229, 1041, 2606, 1692, 680, 2746,
    //     568, 3312
    // };
    // uint16_t pwmf[128] = {
    //     17, 3312, 2761, 568, 583, 2746, 2649, 680, 1637, 1692, 723, 2606, 2288, 1041,
    //     1100, 2229, 1409, 1920, 2662, 667, 3281, 48, 233, 3096, 756, 2573, 2156, 1173,
    //     3015, 314, 3050, 279, 1703, 1626, 1651, 1678, 2789, 540, 1789, 1540, 1847, 1482,
    //     952, 2377, 1461, 1868, 2687, 642, 939, 2390, 2308, 1021, 2437, 892, 2388, 941,
    //     733, 2596, 2337, 992, 268, 3061, 641, 2688, 1584, 1745, 2298, 1031, 2037, 1292,
    //     3220, 109, 375, 2954, 2549, 780, 2090, 1239, 1645, 1684, 1063, 2266, 319, 3010,
    //     2773, 556, 757, 2572, 2099, 1230, 561, 2768, 2466, 863, 2594, 735, 2804, 525,
    //     1092, 2237, 403, 2926, 1026, 2303, 1143, 2186, 2150, 1179, 2775, 554, 886, 2443,
    //     1722, 1607, 1212, 2117, 1874, 1455, 1029, 2300, 2110, 1219, 2935, 394, 885, 2444,
    //     2154, 1175
    // };
    // cortos_printf("\n[INFO]  :   Twiddle factors generated.\n");


    //------------------------ To Test (End) ------------------------//

    // Generate Private Key (s) and Public Key (b)
    uint16_t scap[2][256];
    uint16_t bcap[2][256];

    t00_0 =__ajit_get_clock_time();
    key_gen(scap, bcap, psis, pwmf);
    t00_1 = __ajit_get_clock_time();
	cortos_printf("[RESULT]              :           Key generation Time: %f %f\n", (double) (t00_1 - t00_0));
    


    cortos_printf("[INFO]           :           Public Key and Secret Key generated!\n");

    // uint16_t scap[2][256] = {
    //     {
    //         1291, 53, 170, 2072, 1204, 1473, 972, 344, 2474, 2826, 1913, 1328, 207, 3308, 2032, 1126,
    //         652, 1853, 1640, 493, 377, 2634, 1552, 1406, 2509, 483, 3270, 912, 906, 3062, 93, 691,
    //         1306, 2172, 2824, 515, 2604, 1391, 1289, 3296, 3166, 2913, 1957, 2062, 2495, 822, 1027, 168,
    //         2510, 2211, 2062, 445, 1536, 589, 1045, 1286, 165, 2948, 638, 2409, 2628, 2726, 2681, 1987,
    //         1401, 63, 47, 2475, 555, 1508, 1595, 1353, 1843, 722, 2410, 1852, 776, 87, 2773, 3026,
    //         2318, 3160, 2749, 1442, 2034, 1947, 1131, 3129, 853, 874, 129, 1840, 491, 2692, 87, 1908,
    //         1995, 1526, 2986, 1887, 3184, 1327, 1455, 274, 2819, 636, 2161, 2927, 1269, 2622, 35, 697,
    //         1679, 1603, 2809, 708, 3268, 2789, 3024, 2278, 407, 3132, 1772, 668, 21, 551, 2927, 1822,
    //         291, 478, 1234, 3269, 2244, 2729, 3238, 3040, 950, 2455, 1668, 2012, 1452, 2069, 501, 683,
    //         867, 981, 1594, 3293, 1611, 767, 323, 704, 1456, 432, 2369, 2029, 1388, 617, 1580, 2923,
    //         1956, 2341, 683, 1397, 3321, 1413, 537, 12, 383, 2109, 1167, 1656, 2022, 2941, 2641, 1365,
    //         1595, 1886, 2695, 811, 1949, 1380, 3324, 1326, 887, 3300, 1084, 2661, 2532, 560, 237, 3174,
    //         93, 2943, 1742, 2460, 555, 1344, 392, 344, 2409, 766, 2900, 2800, 670, 1307, 2675, 958,
    //         220, 2931, 3045, 2278, 2130, 2671, 1310, 2949, 3297, 2573, 2784, 1640, 2433, 2284, 719, 2997,
    //         1483, 348, 88, 1345, 1389, 2554, 3284, 75, 1426, 482, 3220, 1944, 2723, 3004, 823, 1046,
    //         1221, 2920, 2867, 1547, 2229, 2394, 3303, 1417, 1906, 936, 2820, 2351, 2747, 3203, 3278, 2245
    //     },
    //     {
    //         367, 1164, 2329, 2251, 1703, 2669, 648, 2840, 297, 2253, 2389, 3152, 1642, 2046, 1469, 1183,
    //         2663, 824, 1967, 2814, 765, 563, 2241, 2617, 1222, 2583, 465, 1864, 3179, 539, 2824, 2405,
    //         1757, 44, 574, 380, 702, 682, 2468, 1185, 3204, 400, 846, 394, 1767, 1366, 1636, 2873,
    //         2176, 2558, 2450, 2203, 1995, 1250, 984, 2205, 975, 2381, 3035, 934, 2674, 812, 753, 1056,
    //         1619, 672, 2938, 1084, 2792, 990, 2587, 787, 458, 2473, 1178, 221, 3075, 1096, 443, 2276,
    //         694, 1109, 371, 1126, 2459, 2208, 2855, 3119, 688, 447, 2315, 2666, 2000, 1155, 2145, 618,
    //         778, 2221, 1959, 32, 3121, 2358, 600, 1932, 124, 2986, 3242, 3058, 1511, 3325, 2288, 1929,
    //         1770, 888, 1008, 1020, 1093, 2479, 263, 1108, 1736, 792, 1193, 731, 2047, 915, 1817, 2339,
    //         2599, 755, 2367, 686, 702, 2148, 2651, 1738, 2120, 3168, 1528, 3141, 2234, 2179, 2077, 3127,
    //         3051, 1560, 821, 1923, 2705, 2370, 72, 1902, 3235, 2442, 2637, 221, 2961, 62, 1725, 2961,
    //         7, 1242, 3005, 275, 1971, 809, 736, 872, 960, 2445, 2451, 51, 361, 2267, 2680, 709,
    //         2429, 1520, 2533, 1178, 2415, 2474, 3063, 970, 768, 71, 2431, 2140, 1166, 796, 1548, 1441,
    //         2921, 129, 1420, 17, 2440, 1993, 2434, 2847, 1629, 2894, 1478, 1101, 789, 2292, 2873, 1014,
    //         1447, 1431, 1494, 1474, 1816, 1992, 2317, 105, 1538, 2591, 1872, 2168, 1026, 565, 210, 1833,
    //         1055, 1025, 3008, 2571, 606, 1534, 3276, 3079, 3239, 225, 2292, 789, 2695, 1515, 2552, 64,
    //         2424, 2894, 261, 2096, 2241, 930, 3256, 2722, 1961, 2094, 476, 1917, 689, 810, 34, 1710
    //     }
    // };

    // uint16_t bcap[2][256] = {
    //     {
    //         778, 423, 3122, 879, 2252, 1793, 2000, 2772, 215, 2994, 3292, 1001, 215, 2047, 2792, 2356,
    //         1778, 3111, 554, 1692, 1488, 2701, 839, 182, 3289, 417, 3039, 2664, 2875, 2682, 2222, 2590,
    //         294, 2483, 487, 2777, 1879, 684, 528, 964, 2202, 2988, 1621, 1421, 1769, 2512, 2287, 1620,
    //         2604, 2581, 2350, 1814, 1712, 2638, 2568, 3236, 113, 1700, 1787, 2217, 2964, 127, 2884, 2766,
    //         1971, 2412, 250, 431, 2607, 577, 2129, 1538, 1945, 1202, 487, 1630, 130, 1021, 2465, 1043,
    //         1483, 1501, 1449, 2089, 2006, 3115, 165, 882, 1509, 3189, 166, 1921, 821, 1170, 1676, 2127,
    //         1189, 2182, 99, 2025, 1074, 2175, 1479, 1532, 1637, 1268, 2035, 704, 2365, 2645, 1411, 870,
    //         1717, 3158, 2223, 1963, 131, 1393, 2098, 1090, 2366, 2799, 1801, 303, 3159, 1433, 286, 610,
    //         2608, 275, 3224, 2438, 1909, 197, 1419, 1395, 1294, 566, 976, 990, 1605, 424, 1288, 2726,
    //         1243, 1729, 2505, 1503, 2630, 304, 1953, 3065, 462, 2481, 457, 3003, 2662, 1135, 75, 2620,
    //         2900, 1311, 2713, 2306, 1461, 2630, 591, 1401, 1578, 1755, 737, 485, 194, 1361, 2079, 1441,
    //         1967, 1965, 804, 1392, 1759, 2834, 1299, 266, 98, 2466, 2882, 1327, 3139, 2222, 3206, 577,
    //         236, 3173, 2589, 2847, 1224, 3057, 1574, 1300, 2183, 176, 423, 2743, 3243, 2129, 1887, 460,
    //         778, 656, 1007, 2865, 1706, 1797, 2792, 2128, 803, 1566, 2793, 1714, 397, 1241, 2871, 2785,
    //         648, 670, 2919, 3165, 2627, 1249, 62, 476, 606, 354, 72, 2027, 1975, 500, 212, 1841,
    //         2370, 709, 1743, 1244, 2994, 2808, 661, 917, 501, 2429, 1504, 1564, 731, 2132, 1832, 555
    //     },
    //     {
    //         2690, 1578, 187, 2388, 1811, 411, 344, 796, 1249, 3157, 453, 3177, 2524, 2678, 2199, 856,
    //         1472, 2902, 2750, 414, 338, 2824, 1878, 153, 186, 1440, 3233, 1041, 647, 178, 626, 1534,
    //         2364, 2942, 1939, 2026, 1947, 140, 2911, 739, 1327, 562, 1249, 641, 1254, 1139, 1102, 622,
    //         129, 1109, 2454, 2071, 745, 1654, 1812, 2676, 2717, 971, 309, 2261, 2410, 1956, 3172, 1203,
    //         1463, 2788, 2280, 726, 1380, 1789, 1804, 267, 2822, 199, 1672, 2758, 2570, 524, 736, 1255,
    //         3175, 129, 234, 2520, 897, 2747, 3052, 2239, 1412, 2406, 2012, 1446, 1345, 349, 2311, 1134,
    //         2752, 162, 946, 1300, 3124, 2758, 457, 992, 1546, 2355, 3236, 1940, 0, 1225, 1390, 47,
    //         2126, 645, 436, 574, 1942, 1928, 232, 2670, 1445, 1463, 2439, 2669, 679, 2515, 2386, 1955,
    //         1870, 1489, 383, 694, 2536, 1483, 208, 2413, 3053, 1737, 1921, 3248, 3289, 1544, 2507, 2717,
    //         1414, 706, 2278, 1983, 449, 1214, 2015, 829, 1504, 2808, 71, 1410, 811, 1811, 1050, 3216,
    //         1433, 486, 2973, 1111, 1181, 40, 1150, 2994, 3021, 2423, 1608, 2959, 2389, 2700, 240, 1215,
    //         3079, 2880, 2125, 34, 2806, 2565, 2757, 401, 1030, 1775, 1508, 1223, 633, 1101, 1306, 2678,
    //         871, 2989, 1174, 2989, 3195, 1954, 1797, 885, 2741, 2682, 2969, 1862, 2363, 1297, 3156, 2085,
    //         2206, 2231, 2534, 3149, 2785, 2985, 1518, 3134, 1649, 647, 2787, 1887, 465, 1462, 1524, 215,
    //         790, 3316, 2391, 2429, 1513, 193, 868, 743, 2808, 356, 2094, 516, 2207, 542, 310, 2353,
    //         1768, 3306, 1177, 2104, 1985, 141, 349, 357, 2240, 3315, 3101, 1839, 1664, 1924, 122, 3038
    //     }
    // };
    



    // //  Display private key (scap) and public key (bcap)
    // cortos_printf("[RESULT]           :            Private Key (scap):\n");
    // for ( i = 0; i < 2; i++) {
    //     for ( j = 0; j < 256; j++) {
    //         cortos_printf("%u ", scap[i][j]);
    //     }
    //     cortos_printf("\n");
    // }
    // cortos_printf("\n");

    // cortos_printf("\n[RESULT]           :            Public Key (bcap):\n");
    // for ( i = 0; i < 2; i++) {
    //     for ( j = 0; j < 256; j++) {
    //         cortos_printf("%u ", bcap[i][j]);
    //     }
    //     cortos_printf("\n");
    // }
    // cortos_printf("\n");

    //input message
    uint8_t m[n2];
    //Fixed input
    // for (i = 0; i < n2; i++) {
    //     if (i < 64) {
    //         m[i] = 0;
    //     } else if (i > 64 & i < 128)  {
    //         m[i] = 1;
    //     }
    //     else if (i > 128 & i < 192) {
    //         m[i] = 0;
    //     } else if (i > 192 & i < 256)  {
    //         m[i] = 1;
    //     }
    // }

    for (i = 0; i < n2; i++) {
            m[i] = 0;
    }

    

    // for ( i = 0; i < n2; i++) {
    //     m[i] = rand() % 2; // Generate either 0 or 1 randomly
    // }

    // Initialize the array with values from 0 to 255
    // for (uint16_t i = 0; i < n2; i++) {
    //     m[i] = i;
    // }

    // Print the original message array

    // cortos_printf("\n");
    // cortos_printf("---------------------------------------------------------------------------------\n");
    // cortos_printf("Original Message:\n");
    // cortos_printf("---------------------------------------------------------------------------------\n");
    // for ( i = 0; i < 256; i++) {
    //     cortos_printf("%u ", m[i]);
    // }
    // cortos_printf("\n");

    // cortos_printf("\n");
    // cortos_printf("---------------------------------------------------------------------------------\n");
    // cortos_printf("\n");

    // Encryption
    uint16_t u[2][256];
    uint16_t v[256];
    uint16_t encoded_m[n2];
    for ( i = 0; i < n2; i++) {
        encoded_m[i] = 1664 * m[i];
    }

    cortos_printf("\n");
    cortos_printf("---------------------------------------------------------------------------------\n");
    cortos_printf("[INFO]             :             Encryption of the message started.\n");
    cortos_printf("---------------------------------------------------------------------------------\n");

    
    t00_0 =__ajit_get_clock_time();
    encrypt(encoded_m, bcap, psis, inv_psis, pwmf, u, v);
    t00_1 = __ajit_get_clock_time();
	cortos_printf("[RESULT]           :           Encryption Time: %f %f\n", (double) (t00_1 - t00_0));
    

    // // Display encrypted message (u and v)
    // cortos_printf("[RESULT]           :           Encrypted Message u\n");
    // for ( i = 0; i < 2; i++) {
    //     for ( j = 0; j < 256; j++) {
    //         cortos_printf("%u ", u[i][j]);
    //     }
    //     cortos_printf("\n");
    // }
    // cortos_printf("\n");


    // cortos_printf("[RESULT]           :           Encrypted Message v\n");
    // for ( i = 0; i < 256; i++) {
    //     cortos_printf("%u ", v[i]);
    // }

    cortos_printf("\n");
    cortos_printf("---------------------------------------------------------------------------------\n");
    cortos_printf("\n");

    // Decryption
    uint16_t d[256];
    cortos_printf("---------------------------------------------------------------------------------\n");
    cortos_printf("[INFO]              :           Decryption of the message started.\n");
    cortos_printf("---------------------------------------------------------------------------------\n");
    
    t00_0 =__ajit_get_clock_time();
    decrypt(scap, u, v, psis, inv_psis, pwmf, d);
    t00_1 = __ajit_get_clock_time();
	cortos_printf("[RESULT]           :           Decryption Time: %f %f\n", (double) (t00_1 - t00_0));
    


    // Decode message
    uint16_t md[256];
    for ( i = 0; i < 256; i++) {
        if (d[i] > 832 && d[i] < 2467) {
            md[i] = 1;
        } else {
            md[i] = 0;
        }
    }

    // // Display decrypted message
    // cortos_printf("[RESULT]           :           Decrypted Message.\n");
    // for ( i = 0; i < 256; i++) {
    //     cortos_printf("%u ", md[i]);
    // }
    
    cortos_printf("\n");
    cortos_printf("---------------------------------------------------------------------------------\n");
    cortos_printf("\n");


    // // Check if original message and decoded message are the same
    bool match = true;
    for ( i = 0; i < n2; i++) {
        if (m[i] != md[i]) {
            match = false;
            break;
        }
    }
    cortos_printf(" \n");
    cortos_printf(" \n");
    cortos_printf("---------------------------------------------------------------------------------\n");
    cortos_printf("[RESULT]           :             Original and decoded messages match: %s\n", match ? "true" : "false");
    cortos_printf("---------------------------------------------------------------------------------\n");


	cortos_printf("[INFO]              :           close the channel..\n");
	scheduleChannelJob(&tc, NULL, NULL);

    return(1);
}

uint8_t main_01 ()
{
	void (*__fn) (void*);
	void *__arg;

	// cortos_printf("------------------------------------------------------\n");
	cortos_printf("[INFO]           :           Entered main_01\n");
	// cortos_printf("------------------------------------------------------\n");

	while(1) 
	{
		while(getChannelJob(&tc, (void**) &__fn, (void**) &__arg))
		{
		}

		if(__fn != NULL)
		{
			(*__fn)(__arg);
			setChannelResponse(&tc, __arg);
		}
		else
			break;
	}

	return(1);

}


